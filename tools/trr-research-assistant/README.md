# TRR Research Assistant

Organizes MITRE ATT&CK technique research into a [Technique Research Report](https://library.tired-labs.org) following the TIRED Labs methodology. Tracks your progress through each research phase, manages scoping and procedure documentation, and generates a TRR draft when you're done.

This tool handles everything **except** the DDM — you build that in [Arrows.app](https://arrows.app), draw.io, or whatever you prefer.

## Setup

```bash
cd tools/trr-research-assistant
pip install -r requirements.txt
```

Requires Python 3.10+. No network access, no API keys.

## Quick Start

**Step 1 — Run the scraper** (separate tool, see [its README](../trr-source-scraper/README.md))

```bash
cd tools/trr-source-scraper
python trr_scraper.py T1003.006 --name "DCSync" --json --platform ad --trr-id TRR0028
```

**Step 2 — Create a project and import**

```bash
cd tools/trr-research-assistant
python trr_research.py init T1003.006 --name "DCSync" --platform ad --trr-id TRR0028
python trr_research.py import ../trr-source-scraper/output/TRR0028_research_brief.json
```

Import reads the scraper JSON, fills in technique metadata, and auto-advances past the understanding phase. You'll see what was populated and what needs attention:

```
✅ Imported scraper data (merge mode, v1.4)

   Understanding Phase — auto-completed ✓
   ──────────────────────────────────────────
   ✓ Technique:      OS Credential Dumping: DCSync
   ✓ Tactics:        Credential Access
   ✓ Platforms:      Windows
   ✓ Objective:      Adversaries may attempt to access credentials...
   ✓ Prerequisites:  Administrator
   ✗ Why Used:       [empty]

   Current Phase: scoping
```

**Step 3 — Scoping** (define what's in and out)

```bash
python trr_research.py scope set-statement "DCSync credential extraction via DRS Remote Protocol"
python trr_research.py scope add-exclusion "Specific tools (Mimikatz, DSInternals)" --rationale "Tangential"
python trr_research.py scope add-exclusion "NTDS.dit file extraction" --rationale "Different essential operations — TRR0015"
python trr_research.py scope add-constraint "Must hold replication privileges" --observable --telemetry "AD audit logs, Win 4662"
python trr_research.py scope complete
```

**Step 4 — Procedures** (document what your DDM analysis revealed)

```bash
python trr_research.py proc add "Standard DRS Replication" \
  --summary "Uses DsGetNCChanges to request replication data from a DC" \
  --distinguishing "Single DsGetNCChanges call targeting specific objects"
python trr_research.py proc edit TRR0028.AD.A --ddm-filename "trr0028_ad_a.png"
python trr_research.py proc map-test TRR0028.AD.A "DCSync"
python trr_research.py proc complete
```

**Step 5 — Validate and generate**

```bash
python trr_research.py validate all
python trr_research.py validate set ops-tested pass
python trr_research.py validate set refs-cited pass
python trr_research.py generate trr-draft
```

Output: `projects/TRR0028/TRR0028_trr_draft.md`

---

## How It Works

The tool is a state machine. Every command reads `state.json`, modifies it, writes it back, and exits. There's no persistent session — you can run commands one at a time, script a batch, or let an AI agent drive it.

### Phases

| Phase | What You Do | Gate to Advance |
|-------|------------|-----------------|
| **Understanding** | Auto-filled by import. Refine if needed. | Technique name, tactics, platforms, objective, and prerequisites are set |
| **Scoping** | Define scope statement, exclusions, constraints | Scope statement + at least 1 exclusion + at least 1 constraint |
| **Procedures** | Document each procedure from your DDM analysis | At least 1 procedure with name, summary, and distinguishing operations |
| **Validation** | Work through completeness and accuracy checklists | All checks marked pass or n/a |

Use `status` to see where you are. Use `--force` on any `complete` command to skip the gate check.

### Project Files

```
projects/TRR0028/
├── state.json                    # All project data
├── TRR0028_scoping_doc.md        # Generated by: generate scoping-doc
├── TRR0028_trr_draft.md          # Generated by: generate trr-draft
└── TRR0028_procedure_table.md    # Generated by: generate procedure-table
```

`generate` commands work at any phase — they render whatever you have and put `[TODO]` markers for the rest.

---

## Commands

Every command accepts `-P <trr_id>` to target a specific project. If omitted, the active project is used (set automatically by `init` or manually by `use`).

### Project Management

| Command | Description |
|---------|-------------|
| `init <technique_id> -n <name> -p <platform> --trr-id <id>` | Create a project and set it as active |
| `use <trr_id>` | Switch active project |
| `import <json_path> [--replace]` | Import scraper JSON. Merges by default; `--replace` overwrites |
| `status` | Show current phase, field counts, last modified |
| `list` | List all projects |
| `meta set-contributors "Name1, Name2"` | Set contributors |
| `meta show` | Show project metadata |

**Platforms:** `windows`, `linux`, `macos`, `ad`, `azure`, `aws`, `gcp`, `k8s`, `network`

### Understanding Phase

Usually auto-completed by import. Use these to refine or fill gaps.

| Command | Description |
|---------|-------------|
| `understand show` | Display all fields and their values |
| `understand set <field> "<value>"` | Set a field |
| `understand complete [--force]` | Mark phase complete |

**Fields:**

| Field | Type | Required |
|-------|------|----------|
| `technique_name` | string | yes |
| `tactics` | comma-separated list | yes |
| `platforms` | comma-separated list | yes |
| `attacker_objective` | string | yes |
| `prerequisites` | string | yes |
| `why_used` | string | no |

Example: `understand set tactics "Credential Access, Lateral Movement"`

### Scoping Phase

| Command | Description |
|---------|-------------|
| `scope set-statement "<statement>"` | One-sentence scope definition |
| `scope add-exclusion "<item>" --rationale "<why>"` | Add to exclusion table |
| `scope remove-exclusion <index>` | Remove by display index (1-based) |
| `scope add-constraint "<text>" [flags] --telemetry "<sources>"` | Add to constraints table |
| `scope remove-constraint <id>` | Remove by ID (C1, C2, etc.) |
| `scope show` | Display scope, exclusions, and constraints |
| `scope complete [--force]` | Mark phase complete |

**Constraint flags:** `--essential` (default), `--immutable` (default), `--observable`, `--not-observable`

### Procedures Phase

| Command | Description |
|---------|-------------|
| `proc add "<name>" --summary "<s>" --distinguishing "<ops>"` | Add a procedure (ID auto-assigned: TRR0028.AD.A, .B, .C) |
| `proc edit <id> [options]` | Edit fields: `--name`, `--summary`, `--distinguishing`, `--narrative`, `--ddm-filename`, `--ddm-description` |
| `proc remove <id>` | Remove a procedure |
| `proc map-test <id> "<test_name>" [--manual]` | Link an emulation test. Substring-matches imported tests |
| `proc show [id]` | Show all or one procedure |
| `proc complete [--force]` | Mark phase complete |

### Validation

| Command | Description |
|---------|-------------|
| `validate all` | Run both checklists |
| `validate completeness` | Run completeness checks only |
| `validate accuracy` | Run accuracy checks only |
| `validate set <check> pass\|fail\|na` | Manually mark a check |

**Check aliases** (use these instead of the full key names):

| Alias | What It Checks |
|-------|---------------|
| `ops-tested` | All operations pass the DDM inclusion test |
| `ops-understood` | All operations are well-understood |
| `paths-explored` | All realistic execution paths are mapped |
| `telemetry-id` | Telemetry identified for each operation |
| `procs-distinct` | Procedures have different essential operations |
| `scope-documented` | Scoping decisions are documented |
| `details-correct` | Technical details are accurate |
| `no-assumptions` | No hidden assumptions in the model |
| `no-tangential` | No tangential (attacker-controlled) elements in DDM |
| `matches-real` | Model matches real-world implementations |
| `refs-cited` | References are cited |
| `ddm-conventions` | DDM follows structural conventions |

### Generation

| Command | Output |
|---------|--------|
| `generate trr-draft` | Full TRR markdown with `[TODO]` markers for unfinished sections |
| `generate scoping-doc` | Scope statement, exclusion table, constraints table |
| `generate procedure-table` | Procedure summary table |

### References

| Command | Description |
|---------|-------------|
| `ref add "<name>" --url "<url>" [--section "<section>"]` | Add a reference (auto-assigned ID: R001, R002) |
| `ref list` | Show all references |
| `ref tag <id> --section "<section>"` | Tag a reference for a TRR section |
| `ref remove <id>` | Remove a reference |

**Sections:** `technique_overview`, `technical_background`, `procedures`

### Notes

| Command | Description |
|---------|-------------|
| `notes add "<text>" [--phase <phase>]` | Add a research note |
| `notes list [--phase <phase>]` | Show notes, optionally filtered |
| `notes remove <id>` | Remove by ID (N001, N002) |

Notes are included as guidance in `generate trr-draft` under the Technical Background `[TODO]` section.

### Telemetry Lookup

| Command | Description |
|---------|-------------|
| `telemetry suggest <operation_type>` | Show common telemetry sources for an operation |
| `telemetry list` | List all operation types for the project's platform |

Example:

```
$ python trr_research.py telemetry suggest process_creation
Sysmon 1 (ProcessCreate)
Win 4688 (Process Creation)
EDR Process Telemetry
CS ProcessRollup2
```

### Utilities

| Command | Description |
|---------|-------------|
| `export state` | Dump state.json to stdout |

---

## Scraper Integration

This tool consumes the JSON output from `trr-source-scraper`. The handoff:

1. Run the scraper with `--json` to produce structured output
2. Run `import <path>` to seed the project state

The import maps scraper data to project fields:

| Scraper Data | Project Field |
|---|---|
| Technique name, tactics, platforms, description | Understanding phase (auto-completes the phase) |
| MITRE references | Reference library |
| Atomic Red Team tests | Emulation test list |
| Existing TRRs/DDMs | Related work for cross-reference |
| Search results (all categories) | Source library for research |
| MITRE data sources | Telemetry hints |

Re-importing merges new data without overwriting manual edits. Use `--replace` to overwrite.

---

## Exit Codes

| Code | Meaning |
|------|---------|
| `0` | Success |
| `1` | User error (missing argument, invalid input, no active project) |
| `2` | Gate check failed (`--force` to override) |
